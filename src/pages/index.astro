---
import Layout from '../layouts/Layout.astro';
import FilterBar from '../components/FilterBar.astro';
import PostCard from '../components/PostCard.astro';
import Pagination from '../components/Pagination.astro';
import { getAllContent } from '../utils/data';

export const prerender = false;

const allPosts = await getAllContent();
const filter = Astro.url.searchParams.get('filter') || 'all';

const filteredPosts = allPosts.filter(post => {
    const isReading = post.category === 'reading' || post.tags.includes('reading');
    if (filter === 'all') return !isReading;
    if (filter === 'starred') return post.tags.includes('hits');
    return post.category === filter || post.tags.includes(filter);
});

const pageParam = Astro.url.searchParams.get('page');
const currentPage = pageParam ? parseInt(pageParam) : 1;
const postsPerPage = 15;
const totalPages = Math.ceil(filteredPosts.length / postsPerPage);
const startIndex = (currentPage - 1) * postsPerPage;
const paginatedPosts = filteredPosts.slice(startIndex, startIndex + postsPerPage);
---

<Layout title="Writing â€” Sam Rhea">
    <header class="mb-8">
        <FilterBar activeFilter={filter} />
    </header>

    <section class="divide-y divide-midnight-800/30">
        {paginatedPosts.length === 0 ? (
            <p class="text-midnight-500 py-8">No posts found.</p>
        ) : (
            paginatedPosts.map((post) => (
                <PostCard 
                    title={post.title}
                    date={post.date}
                    url={post.url}
                    description={post.description}
                    isExternal={post.isExternal}
                />
            ))
        )}
    </section>

    <Pagination currentPage={currentPage} totalPages={totalPages} filter={filter} />
</Layout>